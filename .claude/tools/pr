#!/bin/bash
# diff íŒŒì¼ AI ë¶„ì„ ê¸°ë°˜ PR ìƒì„±

DIFF_FILE="$1"
SUMMARY="$2"

if [ -z "$DIFF_FILE" ]; then
    echo "ì‚¬ìš©ë²•: pr-diff <diffíŒŒì¼> [ìš”ì•½]"
    echo "ì˜ˆì‹œ: pr-diff changes.diff 'API ìˆ˜ì •'"
    echo "  - diffíŒŒì¼: ë¶„ì„í•  ë³€ê²½ì‚¬í•­ íŒŒì¼"
    echo "  - ìš”ì•½: ì‘ì—… ë‚´ìš© í•œì¤„ ìš”ì•½ (ì„ íƒ)"
    exit 1
fi

if [ ! -f "$DIFF_FILE" ]; then
    echo "âŒ diff íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $DIFF_FILE"
    exit 1
fi

echo "ğŸ” Claude AIë¡œ diff íŒŒì¼ ë¶„ì„ ì¤‘..."
echo "ğŸ“ íŒŒì¼: $DIFF_FILE"

# diff íŒŒì¼ ë‚´ìš© ì½ê¸°
DIFF_CONTENT=$(cat "$DIFF_FILE")

# ë³€ê²½ëœ íŒŒì¼ë“¤ ì¶”ì¶œ
CHANGED_FILES=$(grep "^+++" "$DIFF_FILE" | sed 's/+++ b\///' | head -5 | tr '\n' ',' | sed 's/,$//')

# ì¶”ê°€ëœ ë¼ì¸ ìˆ˜
ADDED_LINES=$(grep "^+" "$DIFF_FILE" | grep -v "^+++" | wc -l)

# ì‚­ì œëœ ë¼ì¸ ìˆ˜  
DELETED_LINES=$(grep "^-" "$DIFF_FILE" | grep -v "^---" | wc -l)

echo "ğŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½:"
echo "  - ë³€ê²½ëœ íŒŒì¼: $CHANGED_FILES"
echo "  - ì¶”ê°€ëœ ë¼ì¸: $ADDED_LINES"
echo "  - ì‚­ì œëœ ë¼ì¸: $DELETED_LINES"

# AI ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„± (Claude Codeì—ì„œ ì‹¤í–‰ì‹œ)
cat > /tmp/diff_analysis_prompt.txt << EOF
ë‹¤ìŒ diff íŒŒì¼ì„ ë¶„ì„í•´ì„œ PR ì„¤ëª…ì„ ìƒì„±í•´ì£¼ì„¸ìš”:

ë³€ê²½ì‚¬í•­:
$DIFF_CONTENT

ìš”êµ¬ì‚¬í•­:
1. ì–´ë–¤ ê¸°ëŠ¥ì´ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œë˜ì—ˆëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„
2. ì½”ë“œ ë³€ê²½ì˜ ëª©ì ê³¼ íš¨ê³¼ íŒŒì•…  
3. ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë³€í™” ì„¤ëª…

PR í…œí”Œë¦¿ í˜•ì‹ìœ¼ë¡œ í•œê¸€ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
EOF

echo ""
echo "ğŸ¤– Claude AI ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
echo "ğŸ“‹ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ Claudeì—ê²Œ ë¶„ì„ì„ ìš”ì²­í•˜ì„¸ìš”:"
echo ""
echo "claude < /tmp/diff_analysis_prompt.txt"
echo ""
echo "ë˜ëŠ” Claude Codeì—ì„œ ë‹¤ìŒ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë¶„ì„ ìš”ì²­:"
echo "----------------------------------------"
cat /tmp/diff_analysis_prompt.txt
echo "----------------------------------------"

# ê¸°ë³¸ PR í…œí”Œë¦¿ë„ ìƒì„±
TITLE="[FEAT] $(basename "$DIFF_FILE" .diff) ë³€ê²½ì‚¬í•­ ë°˜ì˜"
[ -n "$SUMMARY" ] && TITLE="[FEAT] $SUMMARY"

BODY="## ê°œìš”
- diff íŒŒì¼ ê¸°ë°˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ì ìš©í–ˆìŠµë‹ˆë‹¤
- ì£¼ìš” ë³€ê²½ íŒŒì¼: $CHANGED_FILES  
- ë³€ê²½ ê·œëª¨: +$ADDED_LINES/-$DELETED_LINES lines
$([ -n "$SUMMARY" ] && echo "- ì‘ì—… ë‚´ìš©: $SUMMARY")

## ì„¤ëª…

### What
- ì œê³µëœ diff íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì„ ì²´ê³„ì ìœ¼ë¡œ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤
- ì´ $(echo $CHANGED_FILES | tr ',' '\n' | wc -l)ê°œ íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤

### Why  
- ìš”êµ¬ì‚¬í•­ì— ë”°ë¥¸ ê¸°ëŠ¥ ê°œì„  ë° ì½”ë“œ í’ˆì§ˆ í–¥ìƒì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤
- diff íŒŒì¼ì— ëª…ì‹œëœ ë³€ê²½ì‚¬í•­ì„ í†µí•´ ì‹œìŠ¤í…œì„ ê°œì„ í–ˆìŠµë‹ˆë‹¤

### How
- diff íŒŒì¼ì„ ìƒì„¸íˆ ë¶„ì„í•˜ì—¬ ê° ë³€ê²½ì‚¬í•­ì˜ ëª©ì ì„ íŒŒì•…í–ˆìŠµë‹ˆë‹¤
- ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±ì„ ê³ ë ¤í•˜ë©° ì•ˆì „í•˜ê²Œ ì ìš©í–ˆìŠµë‹ˆë‹¤
- ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤

## ì°¸ê³ 
$([ -n "$ISSUE" ] && echo "- ê´€ë ¨ ì´ìŠˆ: #$ISSUE")
- diff íŒŒì¼: $DIFF_FILE
- ë³€ê²½ í†µê³„: +$ADDED_LINES additions, -$DELETED_LINES deletions
- AI ë¶„ì„ ìš”ì²­ì„ í†µí•´ ë” ìƒì„¸í•œ ì„¤ëª…ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"

echo ""
echo "ğŸ“„ ê¸°ë³¸ PR í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°:"
echo "ì œëª©: $TITLE"
echo ""
echo "$BODY"

# ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ ì œê³µ
echo ""
echo "ğŸ”„ ë‹¤ìŒ ì¤‘ ì„ íƒí•˜ì„¸ìš”:"
echo "1. ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ PR ìƒì„±"
echo "2. Claude AI ë¶„ì„ í›„ ìˆ˜ë™ìœ¼ë¡œ PR ìƒì„±"
echo "3. ì·¨ì†Œ"

read -p "ì„ íƒ (1-3): " choice

case $choice in
    1)
        echo "ğŸš€ ê¸°ë³¸ í…œí”Œë¦¿ìœ¼ë¡œ PR ìƒì„± ì¤‘..."
        BRANCH=$(git branch --show-current)
        MAIN=$(git remote show origin | grep "HEAD branch" | cut -d' ' -f5)
        
        gh pr create \
            --title "$TITLE" \
            --body "$BODY" \
            --base "$MAIN" \
            --head "$BRANCH"
        
        echo "âœ… PR ìƒì„± ì™„ë£Œ!"
        gh pr view --web
        ;;
    2)
        echo "ğŸ¤– Claude AI ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”."
        echo "ë¶„ì„ ì™„ë£Œ í›„ ìˆ˜ë™ìœ¼ë¡œ PRì„ ìƒì„±í•˜ì‹œë©´ ë©ë‹ˆë‹¤."
        ;;
    3)
        echo "âŒ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
        ;;
    *)
        echo "âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤."
        ;;
esac

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f /tmp/diff_analysis_prompt.txt